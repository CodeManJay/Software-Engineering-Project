{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Chat Room</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
          crossorigin="anonymous">
  
          <style type="text/css">
          
            body{
              background-color: white;
            }
            .center{
              margin-top: 150px;
              margin-left: 400px;
            }
  
              .navbar-brand{
                  margin-left: 400px;
              }
  
          
            
          </style>
</head>
<body >

    <div>
      <nav class="navbar navbar-dark bg-dark">
      <div class="container">
        <span class="navbar-brand mb-0 h1 display-1">Chat Room</span>
      </div>
    </div>
    
  

    <div class="center">
      {% block content %}
      <textarea readonly id="chat-log" placeholder="No Messages Yet..." cols="60" rows="10"></textarea><br/><br/>
      <b>User Name : </b>
      <input id="chat-username-input" placeholder="Enter your User Name..." type="text" value="{{ request.user.username }}" size="30"/><br><br/>
      <b>Message :&nbsp; &nbsp; &nbsp </b>
      <input id="chat-message-input" placeholder="Enter your Message..."  type="text" size="30"/><br/><br/>
      <button id="chat-message-submit" type="submit" >Send</button>
      {% endblock %}
  
    </div>
    
  
  </body>
<script src="{% static 'reconnecting-websocket.js' %}"></script>

<script>
    var roomName = "{{ room_name|escapejs }}";
    
    var myDate = new Date(); 
      var myDay = myDate.getDay()
      var hours = myDate.getHours(); 
      var ampm = hours >= 12 ? 'PM' : 'AM'; 
      hours = hours % 12; 
      hours = hours ? hours : 12; 
      var minutes = myDate.getMinutes(); 
      minutes = minutes < 10 ? '0' + minutes : minutes; 
      var myTime = hours  +  ":" + minutes + " " + ampm ;
    

    var chatSocket = new ReconnectingWebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName + '/');

    chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var message = data['message'];
        var username =data['author'];
        document.querySelector('#chat-log').value += (username + ' - ' + message + '    -' + myTime+ '\n \n');
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-username-input').focus();
    document.querySelector('#chat-username-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-username-submit').click();
        }
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };


    document.querySelector('#chat-message-submit').onclick = function(e) {
        var messageInputDom = document.querySelector('#chat-message-input');
        var usernameInputDom = document.querySelector('#chat-username-input');
        var message = messageInputDom.value;
        var username = usernameInputDom.value;
        chatSocket.send(JSON.stringify({
           'author' : username,
            'message': message
        }));

        messageInputDom.value = '';
        usernameInputDom.value = '{{ request.user.username }}';
    };
</script>
</html>


